---
title: "Extracting time series from eReef datasets"
author: "Denisse Fierro Arcos"
date: "2024-01-14"
output:
  github_document:
    toc: true
    html_preview: false
---

# Extracting time series from eReefs outputs

[eReefs](https://research.csiro.au/ereefs/) is a group of environmental models managed by various government and non-profit organisations. These models can simulate past conditions and predict future states for hydrodynamic conditions, sediment transport, and water quality within the Greet Barrier Reef (GBR). The aim is to provide information about the past and current states of GBR, as well as its likely future condition.  
  
eReefs model outputs can be found in the DMS under the [**eReefs** collection](https://stac.development.reefdata.io/browser/collections/ereefs). In this notebook, we will use the [daily hydrodynamic model outputs at a 1 km resolution](https://stac.development.reefdata.io/browser/collections/ereefs/items/aims-ereefs-agg-hydrodynamic-1km-daily?.asset=asset-data) as an example of how to extract data.  
  
## Loading libraries
  
```{r, message = F, warning = F}
#Loading useful_functions script
source("useful_functions.R")
#Mapping
library(terra)
library(sf)
library(tidyterra)
library(rnaturalearth)
```

## Connecting to RIMREP collection via API

From the STAC catalogue item for the [daily hydrodynamic model outputs at a 1 km resolution](https://stac.development.reefdata.io/browser/collections/ereefs/items/aims-ereefs-agg-hydrodynamic-1km-daily?.asset=asset-data), we can get the link to the API from the *Additional Resources* section of the page on the left under the map.  
    
As an example, we will access data for using the API link for the period between 2023-01-01 and 2023-01-07. 

For this example, we will select data for coastal waters up to 150 km away from the coastline between Daintree and Cairns.  
  
**Note:** Before running the code chunk below, ensure you have the DMS token ready to be pasted in the `connect_dms_dataset` function below. Alternatively, you can store it in the `RIMREP_DMS_TOKEN` environmental variable as explained in the [README page](https://github.com/aodn/rimrep-training/blob/main/CoTS-training-Jan2024/README.md). If you do not have this token, you will not be able to access our API, please contact the RIMReP team to set up an account by emailing [info-dms@utas.edu.au](mailto:info-dms@utas.edu.au).  
    
```{r}
#Defining API URL (obtained from STAC catalogue)
base_url <- "https://pygeoapi.development.reefdata.io/collections/aims-ereefs-agg-hydrodynamic-1km-daily/"

#Defining variable of interest (obtained from STAC catalogue)
variable_name <- "temp"

#Connecting to DMS to extract data
temp_gbr <- connect_dms_dataset(base_url, variable_name,
                           start_time = "2023-01-01", end_time = "2023-01-07", 
                           lon_limits = c(145.30, 146.90),
                           lat_limits = c(-17, -16.30), access_token = access_token)
```

We will plot the first layer of this raster in a map.  
  
```{r}
#Get map of Australia
aust <- ne_countries(country = "Australia", returnclass = "sf")

#Start a plot
ggplot()+
  #Plot one raster layer
  geom_spatraster(data = temp_gbr$`temp_k=-140_1`)+
  #Choose a nicer palette for our map
  scale_fill_distiller(palette = "YlOrRd")+
  #Add Australia
  geom_sf(data = aust)+
  #Establish map limits
  lims(x = c(145.30, 146.90), y = c(-17, -16.30))+
  #Apply a nice predefined theme
  theme_bw()+
  #Add a title
  labs(title = "Temperature in degrees C")+
  #Center the plot title
  theme(plot.title = element_text(hjust = 0.5))
```
  
